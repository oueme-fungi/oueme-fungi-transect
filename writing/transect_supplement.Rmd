---
title: 
  - "Supplementary Information for:"
  - "Long- and short-read metabarcoding technologies reveal similar spatio-temporal structures in fungal communities"
author: 
  - Brendan Furneaux^1^,
  - Mohammad Bahram^2,3^,
  - Anna Rosling^4^,
  - Nourou S. Yorou^5^,
  - Martin Ryberg^1^
  - ^1^Program in Systematic Biology,
    Department of Organismal Biology,
    Uppsala University,
  - Uppsala, Sweden
  - ^2^Department of Ecology,
    Swedish University of Agricultural Sciences,
    Uppsala, Sweden
  - ^3^Institute of Ecology and Earth Sciences,
    University of Tartu,
    Tartu, Estonia
  - ^4^Program in Evolutionary Biology,
    Department of Ecology and Genetics,
    Uppsala University,
  - Uppsala, Sweden
  - ^5^Research Unit in Tropical Mycology and Plant-Fungi Interactions,
    LEB,
  - University of Parakou,
    Parakou, Benin
bibliography:
  - "all.bib"
  - "R.bib"
biblio-style: apa
always_allow_html: true
output:
  bookdown::pdf_document2:
    fig_crop: yes
    keep_tex: yes
    toc: false
    latex_engine: xelatex
    includes:
      in_header: preamble_supplement.tex
    citation_package: biblatex
    suppress-bibliography: false
    fontsize: 12pt
    geometry: left=2.5cm, right=2.5cm, top=3cm, bottom=3cm
---

```{r setup, include=FALSE}
library("knitr")
library("ggplot2")
library("magrittr")
library("tidyverse")
library("drake")
library("here")
library("phyloseq")
library("kableExtra")
tryCatch(
  stopifnot(dir.exists(tinytex::tinytex_root())),
  error = function(e) tinytex::install_tinytex()
  )

tinytex::tlmgr_install(setdiff("pdfcrop", tinytex::tl_pkgs()))

knitr::opts_chunk$set(
  dev = "cairo_pdf",
  # dev.args = list(pointsize=32),
  echo = FALSE,
  # results = 'asis',
  # fig.show = 'asis',
  fig.width = 6,
  fig.height = 4.5,
  message = FALSE,
  warning = FALSE,
  external = TRUE,
  out.width = "100%",
  fig.align = "center"
)

options(knitr.table.format = "latex")

light_plan <- readRDS(here("data/plan/drake_light.rds"))
theme_set(theme_bw())

datasets <- read_csv(here("config/datasets.csv"), col_types = "cccccccicccccccccccicc")
regions <- read_csv(here("config/regions.csv"), col_types = "cccciiiiic")
if (!exists("percent", mode = "function")) source(here::here("scripts", "functions_output.R"))

gethash <- function(...) purrr::map_chr(purrr::flatten(list(...)), drake_cache()$get_hash)
```

**Supplementary file 1**: Mapping between samples, indexed primers, and read accession numbers for short amplicons.

**Supplementary file 2**: Mapping between samples, indexed primers, and read accession numbers for long amplicons.

**Supplementary file 3**: ML tree of all long metabarcoding ASVs (ITS1--5.8S--ITS2--LSU) assigned to kingdom Fungi.
Thick branches represent rapid bootstrap values >90%.
Taxonomic assignment by PHYLOTAX, based on assignments using RDPC, SINTAX, and IDTAXA, with Unite, Warcup, and RDP-LSU reference databases. 
Taxon names in blue were not fully resolved with PHYLOTAX, and are given as a list of alternative assignments, along with the number of methods which gave each assignment (max 9).
Taxon names in red were reconstructed as polyphyletic.
In some cases, this may be due to a poorly identified sequence "splitting" the group (e.g., the single *Monascus* sequence nested in *Aspergillus*; Aspergillaceae and Trichocomaceae sequences nested in Onygenales), but in other cases, the tree has clearly failed to reconstruct groups which are generally considered to be monophyletic based on multi-gene trees (e.g., Dothidiomycetes, Cantharellales).

# Supplementary methods

## Sample preservation and extraction {#Sampling-supplement}

Soil samples described in the main text were placed into separate 2.0\ mL microtubes containing 750\ mL of field lysis/preservation buffer and lysis beads (Xpedition^TM^ Soil/Fecal DNA miniprep, Zymo Research Corporation, Irvine, California, USA).
Due to the inavailability of refrigeration, extraction was initiated in the field according to the manufacturers instructions by lysis using a handheld bead-beater (TerraLyser^TM^; Zymo Research Corporation).

An additional sample was collected at every sampling location (1-m spacing) in 2016 using LifeGuard^TM^ Soil Preservation Solution (MO BIO, Carlsbad, CA; USA) for preservation, without field lysis.
Sequencing results for these 50 samples differed significantly (PERMANOVA with 9999 permutations, $p < `r readd(buffer_adonis)["buffer","p.value"] %>% formatC(format = "f")`$, $R^2 = `r readd(buffer_adonis)["buffer","R2"] %>% formatC(format = "f", digits = 2)`$) from samples preserved using the Xpedition^TM^ lysis buffer (Figures \@ref(fig:buffer-pcoa), \@ref(fig:buffer-compare-long), and \@ref(fig:buffer-compare-short)); as such the LifeGuard preserved samples were excluded from our spatial analyses.
However, reads from these samples were included in the full bioinformatics workflow, including ASV calling, OTU clustering, and phylogenetic trees.

After returning to the laboratory, DNA was extracted using the Xpedition^TM^ Soil/Fecal Prep kit (see above).
Samples preserved using LifeGuard were first centrifuged at 10\ 000\ g for 1\ minute, after which the supernatant was removed and DNA was extracted from the remaining soil using the Soil/Fecal Prep kit as for the other samples.
DNA was quantified fluorometrically using Quant-iT^TM^ PicoGreen^TM^ dsDNA (Thermo Fisher Scientific, Waltham, MA, USA) fluorescent indicator dye on a Infinite F200 plate spectrofluorometer (Tecan Trading AG, MÃ¤nnedorf, Switzerland) according to the manufacturer's protocol.

## Denoising and clustering {#denoising-supplement}

### Denoising long-reads: the numbers are against us {#long-numbers}

The DADA2 algorithm requires that the seed sequence of each ASV be represented by at least two error-free reads [@callahan2016].
If sequencing errors are uniformly distributed, then the probability that a given read will be error-free is $(1-\epsilon)^L$, where $\epsilon$ is the sequencing error rate and $L$ is the read length in base pairs.
Then the number of reads of a given sequence that would be required to obtain two error-free reads in expectation is $2/(1-\epsilon)^L$.
For the combination of long sequences (median $L=`r readd(demuxlength)['pb_500']` \text{ bp}$ after trimming) and moderate error rate (mean $\epsilon= `r format(readd(demuxqual)['pb_500'], digits = 4)`$ based on ccs quality scores) for the long amplicon in this study, the expected number of reads required to achieve two error-free reads is `r format(as.integer(round(2/(1 - readd(demuxqual)['pb_500'])^readd(demuxlength)['pb_500'])), big.mark = " ")`.
Given the high diversity relative to sequencing depth in this study (`r readd(region_table)$ASVs[readd(region_table)$seq_run == "pb_483" & readd(region_table)$region == "short"]` ASVs based on PacBio short amplicons, `r format(readd(demuxcounts)["pb_500"], format = "d", big.mark = " ")` trimmed long amplicon reads), this requirement could not have been met for the long amplicons except by the most abundant sequences.
In comparison, the equivalent requirement for the short amplicon ($L=`r readd(demuxlength)['pb_483']` \text{ bp}$, $\epsilon=`r readd(demuxqual)['pb_483']`$) is only `r round(2/(1 - readd(demuxqual)['pb_483'])^readd(demuxlength)['pb_483'], 1)` reads.

In order to bypass this limitation, we implemented a workflow which divides the long rDNA amplicon into homologous domains (new R package `LSUx`), denoises the domains individually using DADA2, and then recombines the denoised domains to form full-length denoised amplicons (new R package `tzara`).
The steps of this workflow are detailed below.

### Splitting the rDNA into regions with covariance models: `LSUx`

Raw reads were divided into shorter regions by matching to covariance models (CM), which are similar to stochastic hidden markov models (HMM), but account for both nucleotide sequence and RNA secondary structure [@eddy1994].
First, the 5.8S rDNA was located in each read by searching for Rfam model RF0002 [@kalvari2018] using `cmsearch` from Infernal 1.1.2 [@nawrocki2013], and all bases before the 5.8S were assigned to ITS1.
No attempt was made to remove the approximately 12\ bp fragment of the SSU from the 5' end of ITS1 in the long amplicons; it was too short to be reliably detected by a CM or the HMMs employed by ITSx [@bengtsson-palme2013].
<!--This approach was able to identify both the 5' and 3' ends of the 5.8S rDNA more consistently and quickly than ITSx [@bengtsson-palme2013, data not shown].-->
A reference alignment including conserved RNA base pairing between and within the 5.8S and relevant portions of LSU was generated from the fungal LSU RNA seed alignment from RDP release 11.5 [@glockner2017; @cole2014] by truncating after the LR5 primer site and using the reference line to annotate the variable regions *sensu* @michot1984 and @raue1988.
A CM was generated from the alignment using `cmbuild` from Infernal.
The fragment of each read beginning with the 5.8S rDNA was then aligned to the CM using `cmalign` from Infernal.
The annotation line in the CM alignment for each read was then used to split the reads into alternating more-conserved and less-conserved domains as shown in Figure\ \@ref(fig:regions),
where LSU1--4 represent the conserved domains of LSU flanking the variable D1--3 domains [@michot1984].
For short amplicons, only (partial) 5.8S, ITS2, and (partial) LSU1 were extracted.
Code to extract the segments, including annotated seed alignments and CMs, is available in the new R package `LSUx`, available and documented at https://github.com/brendanf/LSUx.

### Denoising each domain independently with `DADA2`

Each of the extracted domains was independently filtered for length (Table\ \@ref(tab:region-limits)) and a maximum of three expected errors, and denoised using DADA2.
To test the performance of DADA2 on intermediate-length amplicons, adjacent domains from each read were concatenated to form full ITS (ITS1 + 5.8S + ITS2), partial LSU (LSU1 + D1 + LSU2 + D2 + LSU3 + D3 + LSU4), and partial 32S (5.8S + ITS2 + LSU) datasets, and these were also denoised. 
The DADA2 error model was fit using the 5.8S region for long amplicons, and using the entire read for short amplicons.
Independent error models were fit for each sequencing strategy (i.e., long *vs.* short amplicons, different sequencing technologies).
DADA2 was run with complete pooling for PacBio libraries, and pseudo-pooling
for Ion Torrent libraries.
Chimeras within each region were removed using `removeBimeraDenovoTable` from DADA2.

### Generation of full-length denoised ASVs: `tzara`

For each raw read, the denoised sequences of the different domains were concatenated to form a set of full-length sequences.
For reads which were not assigned a denoised sequence for each domain, the raw read for the domain was used instead.
Because ITS2 is the most variable of the amplified domains as indicated by the greatest number of unique ASVs (Figure\ \@ref(fig:regions)b), reads with identical ITS2 regions are expected to have highly similar sequences in the other regions, unless the amplicon was chimeric.
Therefore, concatenated sequences with identical ITS2 were clustered, and each cluster was aligned in R using the `DECIPHER` package [@wright2015].
Outlier sequences, as determined by mean pairwise distance from the rest of the alignment, were removed from each alignment using the `odseq` package [@jehl2015], using the default threshold of 0.025.
The consensus of the remaining aligned sequences was assigned as the full-length ASV sequence for the entire cluster.
Full-length ASV sequences with more than three ambiguous bases (i.e., no nucleotide >50% at a given position) were removed.
The count and sample distribution of reads assigned to each full-length ASV were calculated in order to form a sample Ã ASV community matrix.
A similar process was used to generate a consensus ITS (ITS1--5.8S--ITS2) and LSU (LSU1--D1--LSU2--D2--LSU3--D3--LSU4) sequence for each ASV.
The process of assigning consensus full-length ASVs was carried out using the new `tzara` package for R, available and documented at https://github.com/brendanf/tzara.

The two packages are modular; `LSUx` can be used to extract domains from LSU for any purpose, and `tzara` can also be used to recombine denoised sequences which were originally separated using other approaches, most notably using the popular and well-established ITSx [@bengtsson-palme2013].
However, for our dataset, the single LSU region which would be extracted by ITSx was still too long to be effectively denoised by DADA2 (Figure\ \@ref(fig:regions)b in main text).

## Phylogenetic inference and taxonomy assignment {#phylogeny-supplement}

### Uniform taxonomic classification for Unite, Warcup, and RDP-LSU {#reannotate}

The taxonomic classification system is based on the Unite database version 8 [@nilsson2019a].
In particular, the classification for fungi was according to @tedersoo2018, and for non-fungal eukaryotes was according to the proposed system of @tedersoo2017c as described in [@tedersoodata2017].
Although the latter system is not formally published, it is consistent with the annotations for non-fungal eukaryotes in the Unite database.
Additionally, it is a system with both purportedly monophyletic taxa and a uniform set of taxon ranks, which make it more appropriate for sequence-based taxonomic assignment algorithms than more accepted classification systems such as that of the International Society of Protistologists [@adl2019], which utilizes hierarchical nameless ranks.
FASTA-format files for the RDP-LSU, Warcup, and Unite reference databases with unified classifications, as well as scripts used to generate them, are available at https://github.com/brendanf/reannotate.

### Rooting the fungal tree {#rooting}

The phylogenetic tree was rooted based on sequences which were confidently assigned to kingdom based on the primary taxonomic assignments.
Assignments based on Warcup were not used at this step because non-Fungi are not included in the dataset, and thus it cannot be used to directly assign kingdoms.
Assignments were considered confident if at least five of the six remaining primary assignment methods (2 databases Ã 3 algorithms) resulted in the same kingdom-level assignment, with no conflicting assignments.
Two ASVs belonging to *Tulasnella*, which is known to have an accelerated rate of molecular evolution in the rDNA and often forms long, unstable branches in phylogenies [@moncalvo2006], were excluded at this step.
This resulted in `r nrow(readd(sure_kingdoms))` confident kingdom assignments, with `r dplyr::count(readd(sure_kingdoms), taxon) %>% glue::glue_data("{n} assigned to {taxon}") %>% glue::glue_collapse(", ", last = ", and ")`.
Inspection of the tree verified that these four kingdoms were reciprocally monophyletic, and the clade containing Alveolata and Viridiplantae was used as an outgroup to root the tree.
The kingdom Fungi was then identified as the minimal clade containing all ASVs which were confidently identified  as kingdom Fungi.
ASVs falling outside this clade, including the excluded *Tulasnella* sequences, were not included in downstream fungal community analysis.

### Refining taxonomic assignments with a phylogenetic tree: `PHYLOTAX` {#phylotax}

PHYLOTAX refinements are based on (1) taxonomic assignments from other, primary assignment algorithms, and (2) a phylogenetic tree.
Taxa at each rank are assigned to a node and all its descendants if that taxon is consistent with the reference-based taxonomic assignments for each of the descendants (Figure\ \@ref(fig:phylotax)).
A taxon assignment is considered to be consistent if at least one primary algorithm assigned that taxon at greater than 50% confidence, or if no primary algorithm successfully classified the sequence at greater than 50% confidence.
The result of this process is twofold.
First, it gives a taxonomic assignment to ASVs which were previously unassigned if they are nested within a clade with consistent preliminary assignments.
Second, it resolves conflicts between the different reference-based algorithms, but only if one of the alternatives is consistent with the assignments of other ASVs in the same clade.
PHYLOTAX is implemented in the new R package `phylotax` at https://github.com/brendanf/phylotax.

## Effect of sequencing strategy on recovered community {#sequencing-strategy-supplement}

ASV and OTU accumulation curves were generated using the `iNEXT` package [@hsieh2016].
Additionally, ASV and OTU richness was estimated for each sample by rarefying to 100 sequences per sample and taking the average of 100 repetitions.
ASV and OTU richness were then compared for each biological sample as sequenced by the different strategies.
For each pair of strategies, the best fit slope for the ASV richness recovered by each strategy was calculated by total least squares using the `deming` package [@R-deming], with the intercept constrained to be 0.
For this analysis, samples in the PacBio and Illumina datasets were combined bioinformatically to match the corresponding samples from the incompletely demultiplexed Ion Torrent dataset.

The effect of sequencing technology and amplicon length on the recovered fungal community
composition, as assessed by the Bray-Curtis dissimilarity was determined by PERMANOVA [@anderson2003] using the `adonis2` function in the `vegan` package [@R-vegan].
Comparisons were made between the fungal communities recovered by the three sequencing strategies that were successfully demultiplexed (Illumina short, PacBio short, PacBio long).

In order to detect potential biases at larger taxonomic scales, ASVs were clustered according to the assigned taxonomic class.
Only samples where all three strategies yielded at least 100\ fungal reads (`r phyloseq::nsamples(readd(tech_class_table))/3` samples), and classes which represented at least 1% of reads in at least one sample (`r phyloseq::ntaxa(readd(tech_class_table))` classes), were included.
The community matrix was normalized to proportional abundance by dividing the counts for each class in each sample by the total number of reads for that sample, but were not rarefied to even sampling depth [@mcmurdie2014].
PERMANOVA included three terms: an indicator for soil sample, comprising all spatiotemporal effects; amplicon length (long vs. short); and sequencing technology (Illumina vs. PacBio).
Partial Principal Coordinates Analysis (PPCoA) was applied to the same dissimilarity matrix using the `capscale` function in `vegan` [@R-vegan].
Spatiotemporal effects, i.e. differences between different samples, were partialed out using a `Condition()` term in the `capscale` model in order to visualize effects due to sequencing technology and amplicon length.

A similar analysis was also applied to only fungi classified as ECM, clustered at the family level.
Sequences were assigned as ECM based on taxonomic assignments using the FUNGuild database [@nguyen2016funguild] via the R package `FUNGuildR` (https://github.com/brendanf/FUNGuildR).
All taxa which included "Ectomycorrhiza" in the guild assignment at any level of confidence were included.

Overall community composition, and differences in composition between amplicon libraries, were visualized as heat trees using the `metacoder` package [@R-metacoder].

## Spatiotemporal analysis {#spatiotemporal-supplement}

Empirical distance-decay curves were generated by plotting mean community dissimilarity as a function of spatial distance, and fit to an exponential model of the form given by Legendre and Legendre (2012) using the nls function in R.
Points in the empirical distance-decay curve were weighted by the number of comparisons within the distance class and the inverse of the distance for the purposes of model fitting.
For datasets where the Mantel correlogram indicated spatial correlation between samples taken in separate years, the model was re-fit with an additional term to represent temporal correlation:
$$D = C_0 + C_1\left[1 - \exp\left(-3  \left(\frac{d}{a_d} + \frac{t}{a_t}\right)\right)\right]$$
where $D$, $d$, and $t$ represent the community dissimilarity, spatial distance, and time lag between samples, respectively, and the parameters are $C_0$, the community dissimilarity between replicate samples ("nugget"); $C_0 + C_1$, the community dissimilarity at long distances ("sill"); $a_d$ the spatial range at which the community dissimilarity has moved 95% of the way from "nugget" to "sill"; and $a_t$, the equivalent temporal range.
The 95% confidence intervals were calculated for the spatial and temporal range parameters by profiling using the `MASS` package.

\newpage

# Supplementary Figures

\listoffigures

(ref:buffer-pcoa-s) Unconstrained Principal Coordinate Analysis (PCoA) ordination of samples preserved with different buffers

(ref:buffer-pcoa) based on Bray-Curtis dissimilarities of relative read abundances.
For each sequencing strategy, only those sampling locations with more than 100 reads each for all three year/preservation buffer combinations were included.

```{r buffer-pcoa, fig.cap="(ref:buffer-pcoa-s), (ref:buffer-pcoa)", fig.scap = "(ref:buffer-pcoa-s)", cache = TRUE, extra.cache = gethash("buffer_asv_pcoa", "buffer_asv_table")}
plot(readd(buffer_asv_pcoa), type = "none", xlab = "PCoA1", ylab = "PCoA2")
points(
  readd(buffer_asv_pcoa),
  select = with(
    as_tibble(phyloseq::sample_data(readd(buffer_asv_physeq))),
    buffer == "Xpedition" & year == "2015" 
  ),
  col = "green",
  pch = 1
)
points(
  readd(buffer_asv_pcoa),
  select = with(as_tibble(phyloseq::sample_data(readd(buffer_asv_physeq))),
                buffer == "Xpedition" & year == "2016"
  ),
  col = "blue",
  pch = 2
)
points(
  readd(buffer_asv_pcoa),
  select = with(as_tibble(phyloseq::sample_data(readd(buffer_asv_physeq))),
                buffer == "LifeGuard" & year == "2016"
  ),
  col = "red",
  pch = 3
)
legend(
  "bottomright",
  legend = c("Xpedition 2015", "Xpedition 2016", "LifeGuard 2016"),
  col = c("green", "blue", "red"),
  pch = 1:3
)
# legend(
#   "topright",
#   legend = with(as_tibble(phyloseq::sample_data(readd(buffer_asv_table))), paste(tech, amplicon)) %>%
#     unique() %>%
#     sort(),
#   lty = 1:3
# )
# vegan::ordiellipse(
#   readd(buffer_asv_pcoa),
#   groups = with(as_tibble(phyloseq::sample_data(readd(buffer_asv_table))), paste(tech, amplicon)),
#   lty = 1:3
# )
```

(ref:buffer-compare-long-s) Comparison of read counts by taxonomic groups for different preservation buffers (Xpedition vs. LifeGuard) and sampling year, for long amplicon libraries

(ref:buffer-compare-long) Reference heat tree (bottom left) shows labeled taxonomic tree.
Nodes and branches are scaled to represent mean relative read abundance across samples.
Colored comparison trees (top and right) illustrate variation in relative read abundance between samples preserved by different techniques or from different years.
For each comparison tree, colors indicate the base 10 log relative abundance ratio for each taxon between two datasets, with red-orange colors indicating greater relative abundance in the dataset indicated above the tree (Xpedition 2015, LifeGuard 2016), and blue-green colors indicating greater relative abundance in the dataset indicated to the right of the tree (Xpedition 2016, Xpedition 2015).
The two Xpedition datasets (blue-green colors in top right and center right trees) show consistently greater relative abundance of Basidiomycota, especially Russulales and Sebacinales, as well as Glomeromycota, Morteriellomycota, Geoglossomycetes, and Pezizomycetes,
while the LifeGuard samples (red-orange colors in top right and center right trees) showed greater relative abundance of Ascomycota in general, especially Aspergillaceae, and also Geminibasidiomycetes.
Differences between the two Xpedition datasets (top center tree) are less pronounced.

```{r buffer-compare-long, fig.scap = "(ref:buffer-compare-long-s)", fig.cap = "(ref:buffer-compare-long-s). (ref:buffer-compare-long)", fig.width = 10, fig.height = 10, out.width = "100%", cache = TRUE, extra.cache = gethash("buffer_compare_long"), dev = "pdf"}
oldtheme <- theme_update(panel.border = element_blank())
readd(buffer_compare_long)
theme_set(oldtheme)
```

(ref:buffer-compare-short-s) Comparison of read counts by taxonomic groups for different preservation buffers (Xpedition vs. LifeGuard) and sampling year, for short amplicon libraries

(ref:buffer-compare-short) Reference heat tree (bottom left) shows labeled taxonomic tree.
Nodes and branches are scaled to represent mean relative read abundance across samples.
Colored comparison trees (top and right) illustrate variation in relative read abundance between samples preserved by different techniques or from different years.
For each comparison tree, colors indicate the base 10 log relative abundance ratio for each taxon between two datasets, with red-orange colors indicating greater relative abundance in the dataset indicated above the tree (Xpedition 2015, LifeGuard 2016), and blue-green colors indicating greater relative abundance in the dataset indicated to the right of the tree (Xpedition 2016, Xpedition 2015).
The two Xpedition datasets (blue-green colors in top right and center right trees) show consistently greater relative abundance of Basidiomycota, especially Sebacinales, as well as Glomeromycota, Geoglossomycetes, and Pezizomycetes,
while the LifeGuard samples (red-orange colors in top right and center right trees) showed greater relative abundance of Ascomycota in general, especially Aspergillaceae, as well as Geminibasidiomycetes.
Differences between the two Xpedition datasets (top center tree) are less pronounced.

```{r buffer-compare-short, fig.scap="(ref:buffer-compare-short-s)", fig.cap = "(ref:buffer-compare-short-s). (ref:buffer-compare-short)", fig.width = 10, fig.height = 10, out.width = "100%", cache = TRUE, extra.cache = gethash("buffer_compare_short"), dev = "pdf"}
oldtheme <- theme_update(panel.border = element_blank())
readd(buffer_compare_short)
theme_set(oldtheme)

```

(ref:phylotax-s) Phylogenetic refinement of taxonomic assignments (PHYLOTAX)

(ref:phylotax) In the example, a clade includes  seven OTUs (A-F), which have been identified by two methods as belonging to taxa "Tax1" or "Tax2", or are unidentified ("unk"), as shown in the tip labels.
No taxon is assigned at node\ 1, because one of the child branches (A) is completely unassigned.
No taxon is assigned at node\ 2, because the assignments at C and F are inconsistent.
Node\ 3 is assigned to Tax2 because this is consistent with at least one of the assignments for both B and C.
Node\ 4 (and thus also node\ 5) is assigned to Tax1 because this is consistent with at least one of the assignments for D and F, and because E, which is nested within the clade defined by D and F, is completely unassigned.

```{r phylotax, fig.height = 2, fig.width = 3, fig.cap = "(ref:phylotax-s). (ref:phylotax)", fig.scap="(ref:phylotax-s)", cache = TRUE, extra.cache = gethash("phylotax_fig")}
readd(phylotax_fig)
```

(ref:sample-depth-s) DNA concentrations after extraction and PCR, and sequencing depth along transects at the two sites Ang and Gan for the years 2015 and 2016

(ref:sample-depth) DNA concentrations after extraction (leftmost column) and PCR (second and third columns), and sequencing depth (right three columns) along transects at the two sites Ang and Gan for the years 2015 and 2016.
Sequencing reads which were filtered out during quality control are colored dark grey.
Dotted horizontal line at 100\ reads indicates cutoff for inclusion in community analysis.
2016 samples were preserved using two different methods (LifeGuard, Xpedition), while 2015 samples were preserved only using Xpedition.

```{r sample-depth, fig.cap = "(ref:sample-depth)", fig.scap = "(ref:sample-depth-s)", fig.env = "sidewaysfigure", fig.width = 9, fig.height = 5, out.width = "100%", cache = TRUE, extra.cache = gethash("conc_plot", "reads_plot")}
ggpubr::ggarrange(readd(conc_plot), readd(reads_plot), ncol = 2, common.legend = TRUE) +
  theme(panel.spacing = unit(0, "mm"))
```

(ref:qual-check-s) Read quality profiles

(ref:qual-check) based on quality scores assigned by technology-specific basecallers. **(a)** per-base error rate for different sequencing strategies; **(b)** expected number of errors per read for different sequencing strategies; **(c)** expected number of errors per read for regions extracted from PacBio long amplicon reads. In **(a)** and **(b)**, R1 and R2 denote the forward and reverse reads, respectively, from Illumina paired-end sequencing.  PacBio short, Ion Torrent, and Illumina datasets were all sequenced from the same short amplicon library.  In **(b)** and **(c)**, quality filtering threshold of 3 expected errors marked as a dashed vertical line.

```{r qual-check, fig.cap = "(ref:qual-check-s), (ref:qual-check)", fig.scap = "(ref:qual-check-s)",fig.height=7, cache = TRUE, extra.cache = gethash("erate_plot", "eexp_plot", "eexp_region_plot")}
ggpubr::ggarrange(
  readd(erate_plot),
  readd(eexp_plot),
  readd(eexp_region_plot),
  ncol = 1,
  labels = "auto"
)
```

(ref:full-length-s) Comparison of the length of denoised sequences from different length amplicons and sequencing technologies

(ref:full-length) Length distribution (*a*, *c*) and empirical cumulative distribution function (ECDF; *b*, *d*) for short (*a*, *b*) and long (*c*, *d*) amplicons, respectively.

```{r full-length, fig.cap = "(ref:full-length-s). (ref:full-length)", fig.scap = "(ref:full-length-s)", fig.height = 6, cache = TRUE, extra.cache = gethash("full_dens_short", "full_ecdf_short", "full_ecdf_short", "full_ecdf_long")}
ggpubr::ggarrange(
  readd(full_dens_short),
  readd(full_ecdf_short),
  readd(full_dens_long),
  readd(full_ecdf_long),
  ncol = 1, heights = c(3, 1.7, 1.2, 2), labels = "auto", vjust = 1
)
```

(ref:region-lengths-s) Length distribution for each region extracted from long amplicons

(ref:region-lengths) Filtering limits are shown as dashed vertical lines.

```{r region-lengths, fig.cap = "(ref:region-lengths-s). (ref:region-lengths)", fig.scap = "(ref:region-lengths-s)", fig.height = 6, cache = TRUE, extra.cache = gethash("region_length_fig")}
readd(region_length_fig)
```

(ref:ITS2-length-s) Comparison of the length of denoised ITS2 sequences extracted from different length amplicons and sequencing technologies

(ref:ITS2-length) *a*) Length distribution.  *b*) Empirical cumulative distribution function.

```{r ITS2-length, fig.cap = "(ref:ITS2-length-s). (ref:ITS2-length)", fig.scap = "(ref:ITS2-length-s)", fig.height = 6, cache=TRUE, extra.cache=gethash("its2_dens", "its2_ecdf")}
ggpubr::ggarrange(
  readd(its2_dens),
  readd(its2_ecdf),
  ncol = 1,
  labels = "auto",
  heights = c(4, 2)
)
```

(ref:read-compare-s) Comparison between read numbers for different sequencing strategies

(ref:read-compare) by ASV (**a**) and 97% OTU (**b**). ASVs/OTUs which were detected by one sequencing strategy but not the other are plotted as tick marks along the axes. Dashed line represents a constant ratio of read numbers. The blue line is a LOESS smooth of the data, with associated uncertainty in grey shading. $R^2$ value displayed is for log-transformed non-zero read numbers.

```{r read-compare, fig.cap="(ref:read-compare-s), (ref:read-compare)", fig.scap="(ref:read-compare-s)", fig.height=8, cache=TRUE, extra.cache=gethash("multi_table","comparisons")}
ggpubr::ggarrange(
  read_comparison(
    readd(multi_table),
    readd(comparisons),
    type = "ASV"
  ),
  read_comparison(
    readd(multi_table),
    readd(comparisons),
    type = "OTU"
  ),
  ncol = 1,
  labels = "auto",
  label.x = 0.9
)
```

(ref:accum-OTU-s) 97% OTU accumulation curves

(ref:accum-OTU) Each curve represents rarefaction of a single sample or pooled pair of samples.
Points at the end of each curve represent the actual read depth and observed OTU richness.
Panel at left has enlarged scale to show PacBio more clearly.
Vertical dashed line at 100 reads indicates rarefaction level for OTU richness comparisons.

```{r accum-OTU, fig.cap="(ref:accum-OTU-s). (ref:accum-OTU)", fig.scap = "(ref:accum-OTU-s)"}
readd(accum_plot_OTU)
```


(ref:alpha-compare-otu-s) Comparison of OTU richness between sequencing technologies

(ref:alpha-compare-OTU) Each point represents the richness of one or two pooled samples, as determined by two different sequencing strategies. All values represent the average of 100 replicate rarefactions with a sample depth of 100 reads.  Because samples in the same well on different plates could not be demultiplexed in the Ion Torent dataset, these samples were also bioinformatically pooled in the other datasets prior to rarefaction. Blue lines are total least squares fit with 95% confidence interval, with the given slope (and 95% confidence interval) and R^2^ value. Dashed diagonal line indicates ideal slope of 1.

```{r alpha-compare-otu, fig.scap="(ref:alpha-compare-otu-s)", fig.cap="(ref:alpha-compare-otu-s) (ref:alpha-compare-OTU)"}
grid::grid.newpage()
grid::grid.draw(remove_empty_facets(readd(alpha_plot_OTU)))
```

(ref:taxa-s) Heat tree summarizing taxonomic composition of soil community

(ref:taxa) Color and size of nodes represent the fractional ASV richness of that taxonomic group.
Color and thickness of branches represent the fractional read abundance of all ASVs belonging to that taxonomic group.
Diverse but relatively rare groups are thus shown as large, dark-colored nodes on relatively thin, light-colored branches (e.g., Dothideomycetes), while common but relatively non-diverse groups are shown as small, light-colored nodes on relatively thick, dark-colored branches (e.g., Russulales).
Groups which are not represented by at least 1% of reads or 1% of ASVs in any dataset are collapsed into nodes labeled "*".
ASVs which could not be further assigned are labelled "?".
ASV richness and read abundance are displayed as the mean across sequencing runs.
Taxonomic assignment is by strict consensus of multiple ITS databases (Unite, Warcup) and assignment algorithms (RDPC, SINTAX, IDTAXA).
The RDP-LSU database was not included, to ensure consistent assignment between long and short amplicon libraries.

```{r taxa, fig.cap = "(ref:taxa-s). (ref:taxa)", fig.scap="(ref:taxa-s)", fig.width = 9, fig.height = 5, out.width="100%", fig.env = "sidewaysfigure", cache=TRUE, extra.cache=gethash("heattree")}
theme <- theme_update(panel.border = element_blank())
readd(heattree)
theme_set(theme)
```

(ref:heattree-length-compare-s) Variation in read abundance and diversity for different amplicons across the taxonomic tree

(ref:heattree-length-compare) Color of nodes indicates variation in read abundance, while color of edges represents variation in ASV richness.
In both cases red-orange represents increased prevalence in the short amplicon library, while blue-green represents increased prevalence in the long amplicon library.
Values are log~10~ of the ratio of mean values across sequencing runs for each amplicon.
Groups which are not represented by at least 1% of reads or 1% of ASVs in any dataset are collapsed into nodes labeled "*".
ASVs which could not be further assigned are labelled "?".
Only nodes with a log read abundance ratio greater than 0.5 (abundance ratio > 3.2) are labeled.
Refer to Figure\ \@ref(fig:taxa) for complete taxon labeling.

```{r heattree-length-compare, fig.cap = "(ref:heattree-length-compare-s). (ref:heattree-length-compare)", fig.scap = "(ref:heattree-length-compare-s)", out.width = "100%", cache=TRUE, extra.cache=gethash("heattree_length_compare")}
oldtheme <- theme_update(panel.border = element_blank())
readd(heattree_length_compare)
theme_set(oldtheme)
```

(ref:short-its-s) Kingdom-level taxonomic composition of ITS2 ASVs $\le 140$ bp

(ref:short-its) Vertical axis shows fraction of total reads $\le 140$ bp in each dataset.

```{r short-its, fig.cap = "(ref:short-its-s). (ref:short-its)", fig.scap = "(ref:short-its-s)", fig.width=7, cache=TRUE, extra.cache=gethash("big_seq_table_ITS2", "taxon_reads"), more.cache = datasets}
readd(taxon_plot_short_kingdom)
```

(ref:ecm-s) Assignment of ECM status to fungal ASVs using FUNGuild database and taxonomic assignments

(ref:ecm) Reads which were not identified to kingdom, or which were identified as a non-Fungi kingdom, are not included.
"unidentified" denotes ASVs which were assigned to kingdom Fungi, but could not be identified to family level or could not be assigned ECM status based on the available identification.
Height of each bar represents the fraction of reads represented by that bar.
Results are shown for different sequencing technologies, amplicons (Long, Short), reference databases (Unite, Warcup, RDP-LSU; "All" denotes algorithms which combine results from multiple databases), and taxonomic assignment algorithms.

```{r ecm, fig.cap = "(ref:ecm-s). (ref:ecm)", fig.scap = "(ref:ecm-s)", fig.width = 7, cache=TRUE, extra.cache=gethash("taxon_plot_ecm"), more.cache = datasets}
readd(taxon_plot_ecm)
```

(ref:ecm-heattree-s) Heat tree showing variation in read abundance and diversity for different amplicons, for ECM taxa only

(ref:ecm-heattree) Red-orange edges (nodes) represent increased read (ASV) count for the short amplicon library, while blue-green edges (nodes) represent increased read (ASV) count for the long amplicon library.
Values are log~10~ of the ratio of mean values across all sequencing technologies for each amplicon.
Groups which are not represented by at least 1% of reads or 1% of ASVs in any dataset are collapsed into nodes labeled "*".
ASVs which could not be further assigned are labelled "?".
Taxonomic assignment is by strict consensus of multiple ITS databases (Unite, Warcup) and assignment algorithms (RDPC, SINTAX, IDTAXA).
The RDP-LSU database was not included, to ensure consistent assignment between long and short amplicon libraries.

```{r ecm-heattree, fig.cap = "(ref:ecm-heattree-s). (ref:ecm-heattree)", fig.scap = "(ref:ecm-heattree-s)", out.width = "100%", , cache=TRUE, extra.cache=gethash("ecm_heattree")}
oldtheme <- theme_update(panel.border = element_blank())
readd(ecm_heattree)
theme_set(oldtheme)
```

(ref:ppcoa-short) Partial Principal Coordinates Analysis (PPCoA) of fungal community using different metabarcoding strategies

(ref:ppcoa) for all fungi (**a**) and ECM fungi (**b**).
Ordination based on the residual variation after spatio-temporal variation (i.e., variation between different soil samples) has been accounted for.
Only samples with at least 100 reads for all three strategies are included.
ASVs are clustered by taxonomic class for all fungi, and by family for ECM fungi.
Abbreviations represent the approximate direction of increase for the classes and families with the highest scores: `r glue::glue_data(readd(tech_class_pcoa_scores), "**{abbrev}**: {class}") %>% glue::glue_collapse(sep = ", ", last = ", and ")`; `r glue::glue_data(readd(tech_ecm_fam_pcoa_scores), "**{abbrev}**: {family}") %>% glue::glue_collapse(sep = ", ", last = ", and ")`.

```{r ppcoa, fig.cap = "(ref:ppcoa-short), (ref:ppcoa)", fig.scap = "(ref:ppcoa-short)", cache=TRUE, extra.cache=gethash("tech_class_pcoa_plot", "tech_ecm_fam_pcoa_plot")}
ggpubr::ggarrange(
  readd(tech_class_pcoa_plot),
  readd(tech_ecm_fam_pcoa_plot),
  common.legend = TRUE,
  legend = "bottom",
  labels = "auto"
)
```

(ref:correlog-cap-s) Mantel correlograms for community dissimilarities and spatio-temporal distance

(ref:correlog-cap) Community dissimilarities are Bray-Curtis (top three rows) or weighted Unifrac (bottom row) dissimilarities and spatial distance, for short (top two rows) and long (bottom two rows) amplicons, and for the entire soil fungal community (left) or only ECM taxa (right).  Unifrac distance was not calculated for short amplicons because it requires that the sequences are placed on a phylogenetic tree.

```{r correlog, fig.cap="(ref:correlog-cap-s). (ref:correlog-cap)", fig.scap = "(ref:correlog-cap-s)", cache=TRUE, extra.cache=gethash(as.list(purrr::keep(light_plan$target, stringr::str_detect, "^correlog.+_PHYLOTAX_")))}
light_plan %>%
  filter(startsWith(target, "correlog")) %>%
  select(target) %>%
  separate(
    target,
    into = c("step", "guild", "metric", "tech", "amplicon", "method", "tdist"),
    sep = "_",
    remove = FALSE
  ) %>%
  filter(startsWith(method, "PHYLOTAX")) %>%
  mutate(
    tdist = paste(tdist, "year"),
    guild = plyr::mapvalues(guild, c("fungi", "ecm"), c("all Fungi", "ECM")),
    metric = plyr::mapvalues(metric, c("bray", "wunifrac"), c("Bray-Curtis", "W-UNIFRAC")),
    amplicon = factor(amplicon, levels = c("Short", "Long"))
  ) %>%
  mutate_at("target", purrr::map, readd, character_only = TRUE) %>%
  mutate_at("target", purrr::map, "mantel.res") %>%
  mutate_at("target", purrr::map, as.data.frame) %>%
  unnest(target) %>%
  filter(complete.cases(.)) %>%
  mutate(Significant = `Pr(corrected)` < 0.05) %>%
  ggplot(aes(class.index, Mantel.cor, group = tdist, color = tdist, shape = Significant)) +
  geom_point(size = 3) +
  geom_line(alpha = 0.3, size = 1.5) +
  geom_hline(yintercept = 0, linetype = 2, alpha = 0.5) +
  # geom_line(aes(y = exp(predict(bc_fit)))) +
  scale_y_continuous(name = "Mantel correlation") +
  scale_x_continuous(breaks = c(0, 3, 6, 9, 12)) +
  scale_color_discrete(name = "Time lag") +
  xlab("Distance (m)") +
  ggnomics::facet_nested(amplicon + tech + metric ~ guild, scales = "fixed", nest_line = TRUE) +
  scale_shape_manual(values = c("TRUE" = 16, "FALSE" = 1)) +
  theme(strip.background = element_blank())
```

\FloatBarrier

# Supplementary tables

\listoftables

\newpage

\FloatBarrier

```{r region-limits}
regions %>%
  select(Region = region, "Min. length" = min_length, "Max. length" = max_length) %>%
  right_join(
    tibble(Region = c("ITS1", "5_8S", "ITS2", "LSU1", "D1", "LSU2", "D2", "LSU3", "D3", "LSU4")),
    by = "Region"
    ) %>%
  mutate_at("Region", str_replace_all, "_", ".") %>%
  knitr::kable(
    booktabs = TRUE,
    caption = "Minimum and maximum allowed lengths for each extracted region."
  )
```

(ref:readcounts-s) Number of Amplicon Sequence Variants (ASV) and reads at different pipeline stages

(ref:readcounts) **Raw**: raw reads as delivered by sequencing center (CCS reads for PacBio);
**Trim**: reads with primers and demultiplexing barcodes removed;
**Filter (full)**: full length amplicons with a maximum of three expected errors;
**LSUx**: reads with a positive CM hit for 5.8S, allowing regions to be extracted;
**Filter (ITS2)**: extracted ITS2 regions with a maximum of three expected errors;
**ITS2**: ASVs obtained for the ITS2 region, and reads successfully mapped to an ITS2 ASV;
**short**, **ITS**, **LSU**, **long**: ITS2-based ASVs mapped to consensus ASVs for longer regions, where \"short\" and \"long\" denote the full-length short and long amplicons, respectively.
*Italicized* numbers represent mapping via ITS2 ASVs to amplicons originally sequenced by another technology.

```{r bioinfo, cache=TRUE, extra.cache=gethash("bioinf_table", "bioinf_header")}
readd(bioinf_table) %>%
  rownames_to_column("step") %>%
  mutate_if(is.numeric, prettyNum, big.mark = ",") %>%
  mutate_all(str_replace, "NA", "â") %>%
  mutate_at(
    vars(contains("Short")),
    kableExtra::cell_spec,
    italic = .$step %in% c("ITS", "LSU", "long"),
    escape = FALSE
  ) %>%
  mutate_at(
    vars(contains("Long")),
    kableExtra::cell_spec,
    italic = .$step %in% c("short"),
    escape = FALSE
  ) %>%
  column_to_rownames("step") %>%
  set_names(gsub(".*_", "", names(.))) %>%
  kable(
    booktabs = TRUE,
    caption = "(ref:readcounts-s). (ref:readcounts)",
    caption.short = "(ref:readcounts-s)",
    align = "rrrrrr",
    linesep = c(
      rep("", 2),
      "\\addlinespace",
      rep("", 2),
      "\\addlinespace",
      rep("", 4)
    ),
    escape = FALSE
    ) %>%
  kableExtra::add_header_above(
    header = c(
      " " = 1,
      readd(bioinf_header)$amplicon[c(TRUE, FALSE)] %>% set_names(rep(2, length(.)), .)
    )
  ) %>%
  kableExtra::add_header_above(
    header = c(
      " " = 1,
      rle(readd(bioinf_header)$tech) %$% set_names(lengths, values)
    )
  )
```

\setlength{\tabcolsep}{1ex}

(ref:venn-table-asv-s) Correspondences between ASVs found by different sequencing strategies

(ref:venn-table-asv) Each row shows the number of ASVs (*ASVs*) shared uniquely by one or more datasets, including the fraction of total ASVs for each dataset (*ASVs frac*), the number of reads represented by those ASVs in each dataset (*reads*) and the fraction of total reads for the dataset (*reads frac*).

```{r venn-table-asv, cache=TRUE, extra.cache=gethash("venn_ASV"), more.cache=venn_table}
readd(venn_ASV) %>%
venn_table(ASVs, caption = "(ref:venn-table-asv-s). (ref:venn-table-asv)", caption.short = "(ref:venn-table-asv-s)")
```

(ref:venn-table-otu-s)  Correspondences between 97% OTUs found by different sequencing strategies

(ref:venn-table-otu) Each row shows the number of OTUs (*OTUs*) shared uniquely by one or more datasets, including the fraction of total OTUs for each dataset (*OTUs frac*), the number of reads represented by those OTUs in each dataset (*reads*) and the fraction of total reads for the dataset (*reads frac*).

```{r venn-table-otu, cache=TRUE, extra.cache=gethash("venn_OTU"), more.cache=venn_table}
readd(venn_OTU) %>%
venn_table(OTUs, caption = "(ref:venn-table-otu-s). (ref:venn-table-otu)", caption.short = "(ref:venn-table-otu-s)")
```

(ref:variofit) Parameters for exponential distance-decay fits. Range: range at which exponential function is at 95% of its asymptotic value.

```{r variofit, results="asis", cache=TRUE, extra.cache=gethash("variofit_table")}
 readd(variofit_table) %>%
  mutate_at("conf.low", replace_na, 0) %>%
  mutate(value = ifelse(
    is.na(estimate) | is.na(conf.high) | mantel == FALSE,
    "--",
    sprintf(
      "%s (%sâ%s)",
      formatC(estimate, digits = 2, format = "fg"),
      formatC(conf.low, digits = 2, format = "fg"),
      formatC(conf.high, digits = 2, format = "fg")
      )
  )) %>%
  filter(timelag == "0" | term == "timerange") %>%
  pivot_wider(
    names_from = "term",
    values_from = "value",
    id_cols = c("guild", "amplicon", "tech", "metric", "algorithm"),
    values_fill = list(value = "--")
  ) %>%
  select(Guild = guild, Amplicon = amplicon, Tech = tech, Algorithm = algorithm, Metric = metric, "Space Range (m)" = range, "Time Range (a)" = timerange) %>%
  arrange(Guild, Amplicon, Tech, Algorithm, Metric) %>%
  kable(booktabs = TRUE, caption = "(ref:variofit)", linesep = c(rep("", 5), "\\addlinespace"))
```

\FloatBarrier

---
title: "Filter check"
output: beamer_presentation
---

```{r setup}
# source("install_packages.R")

library(magrittr)
library(tidyverse)
library(glue)
library(Biostrings)
library(ShortRead)
library(ggplot2)

if (interactive()) {
  base.dir <- getwd() %>%
    str_extract(".*oueme-fungi-transect")
  data.dir <- file.path(base.dir, "data")
  lab.dir <- file.path(data.dir, "lab_setup")
  seq.dir <- file.path(base.dir, "raw_data")
  dataset.file <- file.path(lab.dir, "datasets.csv")
  datasets <- read_csv(dataset.file) %>%
    mutate(demux.dir = file.path(seq.dir, Dataset, Seq.Run, "demultiplex"),
           files = map(demux.dir, list.files, pattern = "*.fastq.gz",
                       full.names = TRUE)) %>%
    unnest() %>%
    mutate(filesize = file.size(files)) %>%
    filter(filesize > 0) %>%
    mutate(fastq = map(files, readFastq),
           eexp = map(fastq, ~ 10^(-1 * as(.@quality, "matrix")/10) %>%
                        rowSums(na.rm = TRUE)),
           length = map(fastq, width)) %>%
    select(-fastq) %>%
    unnest %>%
    mutate(erate = eexp/length)
}
```

```{r}
library("scales")
reverselog_trans <- function(base = exp(1)) {
    trans <- function(x) -log(x, base)
    inv <- function(x) base^(-x)
    trans_new(paste0("reverselog-", format(base)), trans, inv, 
              log_breaks(base = base), 
              domain = c(1e-100, Inf))
}

ggplot(datasets, aes(x = erate, group = Dataset, color = Dataset)) +
  geom_step(aes(y = 1- ..y..), stat = "ecdf") +
  scale_x_continuous(name = "Expected number of errors per base",
                     trans = reverselog_trans(10)) +
  scale_y_continuous(name = "Fraction passing")

ggplot(datasets, aes(x = eexp, group = Dataset, color = Dataset)) +
  geom_step(aes(y = 1- ..y..), stat = "ecdf") +
  scale_x_continuous(name = "Expected number of errors",
                     trans = reverselog_trans(10)) +
  scale_y_continuous(name = "Fraction passing")

ggplot(datasets, aes(x = length, group = Dataset, color = Dataset)) +
  geom_step(aes(y = 1- ..y..), stat = "ecdf") +
  scale_x_log10(name = "Length (bp)") +
  scale_y_continuous(name = "Fraction Greater than length")
  
```
```{r}
datasets %>%
  group_by(Dataset) %>%
  do(out = dada2::plotQualityProfile(.$files, aggregate = TRUE) %>%
       print) %>%
  invisible

```

```{r}
fastq@sread[width(fastq)>3000] %>% as.character
```


```{r}
library(dada2)
out2.fastq <- str_replace(out.fastq, fixed(".fastq"), ".trim.fastq")
filterAndTrim(out.fastq, out2.fastq, maxLen = 2999)
derep <- derepFastq(out2.fastq)

err <- learnErrors(derep, errorEstimationFunction = dada2:::PacBioErrfun, multithread = TRUE)
dd <- dada(derep, err = err, BAND_SIZE=32, multithread = TRUE)
```

